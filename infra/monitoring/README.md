# Monitoring Setup (Prometheus & Grafana)

This directory contains Terraform configuration to deploy the **Kube-Prometheus-Stack** (Prometheus, Grafana, Alertmanager) to the EKS cluster.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    terraform apply (infra/monitoring)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Deploys to Namespace: monitoring                                          │
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                   kube-prometheus-stack (Helm)                    │    │
│   │                                                                   │    │
│   │  ┌─────────────────────────────────────────────────────────────┐  │    │
│   │  │                      Prometheus                             │  │    │
│   │  │   - Scrapes metrics from all K8s components                 │  │    │
│   │  │   - Stores time-series data                                 │  │    │
│   │  │   - PVC: prometheus-pvc (EBS gp3)                           │  │    │
│   │  └─────────────────────────────────────────────────────────────┘  │    │
│   │                              │                                    │    │
│   │                              ▼                                    │    │
│   │  ┌─────────────────────────────────────────────────────────────┐  │    │
│   │  │                       Grafana                               │  │    │
│   │  │   - Visualizes Prometheus metrics                           │  │    │
│   │  │   - Pre-built dashboards for K8s                            │  │    │
│   │  │   - User: admin / Password: (auto-generated)                │  │    │
│   │  └─────────────────────────────────────────────────────────────┘  │    │
│   │                              │                                    │    │
│   │                              ▼                                    │    │
│   │  ┌─────────────────────────────────────────────────────────────┐  │    │
│   │  │                    Alertmanager                             │  │    │
│   │  │   - Handles alerts from Prometheus                          │  │    │
│   │  │   - Routes to Slack/Email/etc.                              │  │    │
│   │  └─────────────────────────────────────────────────────────────┘  │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                  Ingress: grafana-alb                             │    │
│   │                                                                   │    │
│   │   Internet ──► ALB (HTTP:80) ──► Grafana Service ──► Grafana Pod │    │
│   │                                                                   │    │
│   │   URL: http://k8s-monitoring-grafana-xxx.elb.amazonaws.com       │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Prerequisites
1. **EKS Cluster** must be running.
2. **AWS Load Balancer Controller** must be installed (see `../eks/README.md`).
   - The monitoring stack creates an Ingress that requires the ALB controller to provision a Load Balancer.
3. **EBS CSI Driver** must be installed (handled by `../eks` terraform usually, or ensures storage classes work).

## Deployment

```bash
terraform init
terraform apply
```

## Accessing Grafana

After deployment, an Ingress resource `grafana-alb` is created in the `monitoring` namespace.

Get the URL:
```bash
kubectl get ingress -n monitoring grafana-alb
```

## Credentials

The default admin password for Grafana is generated by the Helm chart. You can retrieve it via:

```bash
kubectl get secret -n monitoring kube-prometheus-stack-grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo
```

- **User**: `admin`
- **Password**: (Output of command above)
